"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[5174],{379:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"howto/testing","title":"Testing","description":"DataSQRL\'s automated test runner can execute two types of snapshot test via the run command:","source":"@site/docs/howto/testing.md","sourceDirName":"howto","slug":"/howto/testing","permalink":"/docs/howto/testing","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Testing Authorization","permalink":"/docs/howto/testing-authorization"},"next":{"title":"\ud83d\udc69\u200d\ud83d\udcbb How DataSQRL Works","permalink":"/docs/deepdive"}}');var o=n(4848),i=n(8453);const a={},r="Testing",c={},d=[{value:"Modularizing Sources",id:"modularizing-sources",level:2},{value:"Creating Test Configuration",id:"creating-test-configuration",level:2},{value:"Test Data Sources",id:"test-data-sources",level:2},{value:"API Tests",id:"api-tests",level:2},{value:"Run Tests Locally",id:"run-tests-locally",level:2},{value:"Automate Testing",id:"automate-testing",level:2},{value:"Update Tests",id:"update-tests",level:2}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"testing",children:"Testing"})}),"\n",(0,o.jsxs)(t.p,{children:["DataSQRL's automated test runner can execute two types of snapshot test via the ",(0,o.jsxs)(t.a,{href:"../compiler#test-command",children:[(0,o.jsx)(t.code,{children:"run"})," command"]}),":"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["Test tables annotated with the ",(0,o.jsx)(t.code,{children:"/*+test */"})," hint"]}),"\n",(0,o.jsxs)(t.li,{children:["GraphQL operations in the ",(0,o.jsx)(t.code,{children:"test-folder"})," configured under the ",(0,o.jsx)(t.code,{children:"test-runner"})," in the ",(0,o.jsx)(t.a,{href:"../configuration",children:(0,o.jsx)(t.code,{children:"package.json"})}),"."]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["You can combine both types of tests. All snapshots are written to the same ",(0,o.jsx)(t.code,{children:"snapshot-folder"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"modularizing-sources",children:"Modularizing Sources"}),"\n",(0,o.jsxs)(t.p,{children:["In order to separate test data from the real-world data sources of the pipeline, move all ",(0,o.jsx)(t.code,{children:"CREATE TABLE"})," statements into a ",(0,o.jsx)(t.code,{children:"connectors/source-prod.sqrl"})," file which gets imported into the main SQRL script with:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sql",children:"IMPORT connectors.source-{{variant}}.*; -- or you can import into a separate namespace and adjust references\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Note, that ",(0,o.jsx)(t.code,{children:"{{variant}}"})," is a template variable that is used to switch out the source definition and needs to be defined in the ",(0,o.jsx)(t.a,{href:"../configuration",children:(0,o.jsx)(t.code,{children:"package.json"})}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-json",children:'{\n  "script": {\n    "main": "my-project.sqrl",                         \n    "config": { \n      "variant": "prod"\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(t.h2,{id:"creating-test-configuration",children:"Creating Test Configuration"}),"\n",(0,o.jsxs)(t.p,{children:["With the sources modularized out, create a separate test configuration (e.g. ",(0,o.jsx)(t.code,{children:"my_project-test-package.json"}),") for the project:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-json",children:'{\n  "script": {\n    "main": "my-project.sqrl",                         \n    "config": { \n      "variant": "test"\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(t.h2,{id:"test-data-sources",children:"Test Data Sources"}),"\n",(0,o.jsxs)(t.p,{children:["Now, create a new sqrl script for the test data sources ",(0,o.jsx)(t.code,{children:"connectors/source-test.sqrl"})," which defines the same tables as the production sources but using static test data in ",(0,o.jsx)(t.code,{children:".jsonl"})," files. Generate a JSONL file for each table and place it in the ",(0,o.jsx)(t.code,{children:"connectors/test-data"})," folder. Then define the tables based on the originals:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE MyTable (\n    ...same columns as original source but replacing METADATA and non-deterministic columns regular columns and data ...\n    WATERMARK FOR `my_timestamp` AS `my_timestamp` - INTERVAL '0.001' SECOND\n)\n    WITH (\n        'format' = 'flexible-json',\n        'path' = '${DATA_PATH}/my_table.jsonl',\n        'source.monitor-interval' = '10000', -- remove for batch sources\n        'connector' = 'filesystem'\n        );\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Refer to the ",(0,o.jsx)(t.a,{href:"../connectors",children:"connectors documentation"})," for more information on how to source table connectors."]}),"\n",(0,o.jsx)(t.p,{children:"Guidelines for generating test data:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Generate realistic test data that covers the relationship/joins that you want to test"}),"\n",(0,o.jsx)(t.li,{children:"Make sure the test data covers common failure scenarios and edge cases"}),"\n",(0,o.jsx)(t.li,{children:"Set a static event timestamp on test data so that test execution is deterministic"}),"\n",(0,o.jsxs)(t.li,{children:["If the original ",(0,o.jsx)(t.code,{children:"CREATE TABLE"})," definition used ",(0,o.jsx)(t.code,{children:"METADATA"})," columns, convert those to regular columns and add static test data"]}),"\n",(0,o.jsxs)(t.li,{children:["If the original ",(0,o.jsx)(t.code,{children:"CREATE TABLE"})," definition used non-deterministic computed columns (e.g. ",(0,o.jsx)(t.code,{children:"NOW()"}),"), convert those to regular columns and add static test data."]}),"\n",(0,o.jsx)(t.li,{children:"To advance the watermark during test execution, add a dummy record at the end with an event timestamp that is much larger than all test records' timestamps to ensure the watermark advances enough to close windows and flush out all events."}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"api-tests",children:"API Tests"}),"\n",(0,o.jsxs)(t.p,{children:["Optionally, define GraphQL mutations, subscriptions, and queries in ",(0,o.jsx)(t.code,{children:".graphql"})," files inside the configured ",(0,o.jsx)(t.code,{children:"test-folder"})," for ",(0,o.jsx)(t.code,{children:"test-runner"}),". Those queries must be valid queries against the GraphQL schema for the compiled pipeline."]}),"\n",(0,o.jsx)(t.h2,{id:"run-tests-locally",children:"Run Tests Locally"}),"\n",(0,o.jsxs)(t.p,{children:["Use the ",(0,o.jsxs)(t.a,{href:"../compiler#test-command",children:[(0,o.jsx)(t.code,{children:"test"})," command"]})," to execute the tests.\nThe first time you run the tests, snapshots are created in the configured ",(0,o.jsx)(t.code,{children:"snapshot-folder"}),". Validate that those snapshots are correct.\nSubsequent executions of the test will compare snapshots and fail if they are unequal."]}),"\n",(0,o.jsx)(t.h2,{id:"automate-testing",children:"Automate Testing"}),"\n",(0,o.jsx)(t.p,{children:"Check the snapshots into the version control system alongside the code and configure your build or CI/CD tool to run the tests automatically."}),"\n",(0,o.jsx)(t.h2,{id:"update-tests",children:"Update Tests"}),"\n",(0,o.jsx)(t.p,{children:"As you encounter production issues or discover failures during manual testing, convert those scenarios to test data and execute them as part of your test suite to avoid regressions.\nBy setting the event timestamp explicitly, you can precisely recreate a failure scenario and replay it deterministically."})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>r});var s=n(6540);const o={},i=s.createContext(o);function a(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);