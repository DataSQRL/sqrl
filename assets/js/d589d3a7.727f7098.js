"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[7924],{4792:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/getting_started_diagram1-2f42cdff80a615abf8377a591fc8ac43.png"},7161:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"getting-started","title":"Getting Started with DataSQRL","description":"We are going to build a data pipeline with SQRL that:","source":"@site/docs/getting-started.md","sourceDirName":".","slug":"/getting-started","permalink":"/sqrl/docs/getting-started","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","next":{"title":"\ud83d\udcd6 Introduction","permalink":"/sqrl/docs/intro"}}');var r=n(4848),i=n(8453);const a={},o="Getting Started with DataSQRL",l={},d=[{value:"Define SQRL Script",id:"define-sqrl-script",level:2},{value:"Run SQRL Script",id:"run-sqrl-script",level:2},{value:"Access the API",id:"access-the-api",level:2},{value:"Extend the SQRL Script",id:"extend-the-sqrl-script",level:2},{value:"Testing",id:"testing",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Customize GraphQL Schema",id:"customize-graphql-schema",level:2},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"getting-started-with-datasqrl",children:"Getting Started with DataSQRL"})}),"\n",(0,r.jsx)(t.p,{children:"We are going to build a data pipeline with SQRL that:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"ingests statistics on user requests for the token consumption"}),"\n",(0,r.jsx)(t.li,{children:"aggregates token consumption by user"}),"\n",(0,r.jsx)(t.li,{children:"and provides a push-based alert for high token consumption"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"define-sqrl-script",children:"Define SQRL Script"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sql",metastring:"title=usertokens.sqrl",children:"/*+no_query */\nCREATE TABLE UserTokens (\n    userid BIGINT NOT NULL,\n    tokens BIGINT NOT NULL,\n    request_time TIMESTAMP_LTZ(3) NOT NULL METADATA FROM 'timestamp'\n);\n\n/*+query_by_all(userid) */\nTotalUserTokens := SELECT userid, sum(tokens) as total_tokens,\n                          count(tokens) as total_requests\n                   FROM UserTokens GROUP BY userid;\n\nUsageAlert := SUBSCRIBE SELECT * FROM UserTokens WHERE tokens > 100000;\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"UserTokens"})," defines the input data we use for data collection which is exposed as a mutation endpoint. The mutation endpoint has the same schema as the table minus the metadata columns which are automatically inserted from the context. In this example, the ",(0,r.jsx)(t.code,{children:"timestamp"})," metadata refers to the timestamp of the mutation request which gets stored in the ",(0,r.jsx)(t.code,{children:"request_time"})," column."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"TotalUserTokens"})," defines a derived table that aggregates the user tokens by ",(0,r.jsx)(t.code,{children:"userid"}),". The ",(0,r.jsx)(t.code,{children:"query_by_all(userid)"})," hint specifies that this table is accessible through a query endpoint that requires a ",(0,r.jsx)(t.code,{children:"userid"})," argument."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"UsageAlert"})," defines a table that contains all requests where the token consumption exceeds ",(0,r.jsx)(t.code,{children:"100,000"}),". The ",(0,r.jsx)(t.code,{children:"SUBSCRIBE"})," keyword means that this table is exposed as a subscription in the API."]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["The architecture of the pipeline defined by the SQRL script looks as follows:\n",(0,r.jsx)(t.img,{alt:"Initial Pipeline Architecture",src:n(4792).A+"",width:"3414",height:"1462"})]}),"\n",(0,r.jsx)(t.h2,{id:"run-sqrl-script",children:"Run SQRL Script"}),"\n",(0,r.jsxs)(t.p,{children:["Create a file ",(0,r.jsx)(t.code,{children:"usertokens.sqrl"})," with the content above in a new directory:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"mkdir myproject; cd myproject;\nvi usertokens.sqrl;\n"})}),"\n",(0,r.jsx)(t.p,{children:"We can now execute the SQRL script with the compiler:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"docker run -it --rm -p 8888:8888 -p 8081:8081 -p 9092:9092 -v $PWD:/build datasqrl/cmd:latest run usertokens.sqrl\n"})}),"\n",(0,r.jsxs)(t.p,{children:["(Use ",(0,r.jsx)(t.code,{children:"${PWD}"})," in Powershell on Windows)."]}),"\n",(0,r.jsx)(t.p,{children:"Note, that we are mapping the local directory so the compiler has access to the script. We are also mapping a number of ports, so we have access to the API and visibility into the pipeline."}),"\n",(0,r.jsx)(t.h2,{id:"access-the-api",children:"Access the API"}),"\n",(0,r.jsxs)(t.p,{children:["The pipeline is exposed through a GraphQL API that you can access at  ",(0,r.jsx)(t.a,{href:"http://localhost:8888/graphiql/",children:"http://localhost:8888/graphiql/"})," in your browser."]}),"\n",(0,r.jsx)(t.p,{children:"To add user token requests, we run the following mutation:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-graphql",children:"mutation {\n UserTokens(event: {userid: 1, tokens:500}) {\n  request_time\n}\n}\n"})}),"\n",(0,r.jsx)(t.p,{children:'Copy the query into the left-hand panel and click on the "play" button to see the result.'}),"\n",(0,r.jsx)(t.p,{children:"To query the aggregated statistics, run the following query:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-graphql",children:"{\n TotalUserTokens(userid:1) {\n  total_tokens\n  total_requests\n}\n}\n"})}),"\n",(0,r.jsx)(t.p,{children:"To get a push-alert for high token consumption, first run the following subscription:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-graphql",children:"subscription {\n  UsageAlert {\n    userid\n    tokens\n  }\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.em,{children:"While"})," the subscription is running, open a new browser tab for ",(0,r.jsx)(t.a,{href:"http://localhost:8888/graphiql/",children:"GraphiQL"})," and execute this mutation:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-graphql",children:"mutation {\n UserTokens(event: {userid: 2, tokens:400000}) {\n  request_time\n}\n}\n"})}),"\n",(0,r.jsx)(t.p,{children:"If you toggle back to the subscription tab, you should see the request."}),"\n",(0,r.jsxs)(t.p,{children:["Once you are done, terminate the pipeline with ",(0,r.jsx)(t.code,{children:"CTRL-C"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"extend-the-sqrl-script",children:"Extend the SQRL Script"}),"\n",(0,r.jsx)(t.p,{children:"We are going to add information about the user so we can associate token consumption with the organization the user is part of."}),"\n",(0,r.jsx)(t.p,{children:"To demonstrate how to integrate external data sources, we assume that the user information is stored in another system and that we consume a CDC stream of that data. We are going to simulate that CDC stream in the following JSON file:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",metastring:"lines",children:'{"userid":  1, "orgid":  2, "last_updated": "2025-04-20T18:12:00.000Z"}\n{"userid":  2, "orgid":  2, "last_updated": "2025-04-21T11:23:00.000Z"}\n{"userid":  3, "orgid":  1, "last_updated": "2025-04-24T07:15:00.000Z"}\n{"userid":  1, "orgid":  2, "last_updated": "2025-04-25T19:34:00.000Z"}\n{"userid":  2, "orgid":  1, "last_updated": "2025-04-25T21:47:00.000Z"}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Create the file ",(0,r.jsx)(t.code,{children:"local-data/userinfo.jsonl"})," in a new sub-directory ",(0,r.jsx)(t.code,{children:"local-data"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Now add the following to your ",(0,r.jsx)(t.code,{children:"usertokens.sqrl"})," script:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sql",children:"IMPORT local-data.userinfo AS _UserInfo;\n\n_CurrentUserInfo := DISTINCT _UserInfo ON userid ORDER BY last_updated DESC;\n\n_EnrichedUserTokens := SELECT t.*, u.orgid FROM UserTokens t\n   JOIN _CurrentUserInfo FOR SYSTEM_TIME AS OF t.request_time u ON u.userid = t.userid;\n\nTotalOrgTokens := SELECT orgid, sum(tokens) as total_tokens,\n                         count(tokens) as total_requests\n                  FROM _EnrichedUserTokens GROUP BY orgid;\n\nTotalOrgTokensByRange( minTokens BIGINT NOT NULL, maxTokens BIGINT NOT NULL) :=\n    SELECT * FROM TotalOrgTokens\n    WHERE total_tokens >= :minTokens AND total_tokens <= :maxTokens;\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"_UserInfo"}),": We import the data from the ",(0,r.jsx)(t.code,{children:"userinfo.jsonl"}),' file with the IMPORT statement. Note that we are renaming the table to start with an underscore which "hides" to table since we don\'t want this data exposed in the API.']}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"_CurrentUserInfo"}),": The imported data is a CDC stream. To get the most recent information for each user, we deduplicate the data with the ",(0,r.jsx)(t.code,{children:"DISTINCT"})," statement."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"_EnrichedUserTokens"})," enriches the stream of requests with the user information through a ",(0,r.jsx)(t.strong,{children:"temporal join"})," which ensures that we join the stream with the user info that was valid at the point of time when the stream record gets processed. This ensures data consistency."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"TotalOrgTokens"})," aggregates the total tokens by organization."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"TotalOrgTokensByRange"})," defines a query endpoint for the ",(0,r.jsx)(t.strong,{children:"TotalOrgTokens"})," table to query by token range. This function defines two parameters ",(0,r.jsx)(t.code,{children:"minTokens"})," and ",(0,r.jsx)(t.code,{children:"maxTokens"})," and references those in the query using the ",(0,r.jsx)(t.code,{children:":"})," parameter prefix."]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"You can run the script and access the API like we did above."}),"\n",(0,r.jsxs)(t.p,{children:["Note, that when you compile or run the script, the compiler automatically created a connector table from the data in the ",(0,r.jsx)(t.code,{children:"local-data/userinfo.table.sql"})," file. DataSQRL can automatically infer the schema from JSONL or CSV files and generate connectors."]}),"\n",(0,r.jsxs)(t.p,{children:["You can also define connectors manually to ingest data from Kafka, Kinesis, Postgres, Apache Iceberg, and many other sources. Check out the ",(0,r.jsx)(t.a,{href:"/sqrl/docs/connectors",children:"Connectors Documentation"})," to learn how to ingest data from and sink data to many external data systems."]}),"\n",(0,r.jsx)(t.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(t.p,{children:"We can add tests to a SQRL script to ensure it produces the right data, automate those tests to avoid regressions, and enable deployment automation in CI/CD pipelines."}),"\n",(0,r.jsxs)(t.p,{children:["Tests can be added directly to the SQRL script with the ",(0,r.jsx)(t.code,{children:"/*+test */"})," hint:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sql",children:"/*+test */\nUserTokensTest := SELECT * FROM TotalUserTokens ORDER BY userid ASC;\n\n/*+test */\nOrgTokensTest := SELECT * FROM TotalOrgTokens ORDER BY orgid ASC;\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Add those two test cases to the ",(0,r.jsx)(t.code,{children:"usertokens.sqrl"})," script."]}),"\n",(0,r.jsx)(t.p,{children:"We can also add tests as GraphQL queries that get executed against the API. For our example, we need to add a mutation query - otherwise there is no input data to test against."}),"\n",(0,r.jsxs)(t.p,{children:["Add the folder ",(0,r.jsx)(t.code,{children:"tests"})," in the root of the project and add the following mutation query in the file ",(0,r.jsx)(t.code,{children:"tests/addTokens-mutation.graphql"})," to add some test data:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-graphql",children:"mutation {\n    Token1: UserTokens(event: {userid: 1, tokens: 500}) {\n        userid\n    }\n    Token2: UserTokens(event: {userid: 2, tokens: 100}) {\n        userid\n    }\n    Token3: UserTokens(event: {userid: 2, tokens: 200}) {\n        userid\n    }\n    Token4: UserTokens(event: {userid: 1, tokens: 700}) {\n        userid\n    }\n}\n"})}),"\n",(0,r.jsx)(t.p,{children:"Now you can run the test cases with the command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"docker run -it --rm -v $PWD:/build datasqrl/cmd:latest test usertokens.sqrl \n"})}),"\n",(0,r.jsx)(t.p,{children:"When you first run new tests, the test runner creates snapshots for each test case. When you run the test again, it will succeed if the snapshots match or fail if they don't."}),"\n",(0,r.jsx)(t.h2,{id:"deployment",children:"Deployment"}),"\n",(0,r.jsx)(t.p,{children:"To build the deployment assets in the for the data pipeline, execute"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"docker run --rm -v $PWD:/build datasqrl/cmd:latest compile usertokens.sqrl\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"build/deploy"})," directory contains the Flink compiled plan, Kafka topic definitions, PostgreSQL schema and view definitions, server queries, and GraphQL data model."]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"build"})," directory contains two files that are useful to visualize, inspect, and document the data pipelines you create with DataSQRL."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"pipeline_visual.html"})," is a visual representation of the entire data pipeline. Open this file in your browser."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"pipeline_explain.txt"})," contains a textual representation of the pipeline DAG that DataSQRL generates."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"customize-graphql-schema",children:"Customize GraphQL Schema"}),"\n",(0,r.jsx)(t.p,{children:"To inspect the GraphQL API that DataSQRL generates from the SQRL script, execute:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"docker run --rm -v $PWD:/build datasqrl/cmd:latest compile usertokens.sqrl --api graphql\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This creates a file called ",(0,r.jsx)(t.code,{children:"schema.graphqls"})," in the project root directory."]}),"\n",(0,r.jsxs)(t.p,{children:["To make adjustments to the GraphQL schema, rename the file to ",(0,r.jsx)(t.code,{children:"usertokens.graphqls"})," before making modifications: removing fields, changing default values, renaming types, etc. To build the project with the adjusted schema, execute:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"docker run --rm -v $PWD:/build datasqrl/cmd:latest compile usertokens.sqrl usertokens.graphqls\n"})}),"\n",(0,r.jsx)(t.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsx)(t.p,{children:"Congratulations, you made the first big step toward building production-grade data pipelines the easy way.\nNext, check out:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:(0,r.jsx)(t.a,{href:"/sqrl/docs/intro",children:"Full Documentation"})})," for the complete reference, language spec, and more."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:(0,r.jsx)(t.a,{href:"/sqrl/docs/tutorials",children:"Tutorials"})})," if you prefer learning by doing."]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var s=n(6540);const r={},i=s.createContext(r);function a(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);