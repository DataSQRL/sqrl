FROM eclipse-temurin:17-jdk-noble@sha256:30df3b90dc99b30e663c44e74c42f0a942360718b189558e1fe6692504c69a17

ENV DUCKDB_EXTENSIONS_DIR=/opt/duckdb_extensions

ARG DUCKDB_JDBC_VERSION

# Install DuckDB CLI and pre-install extensions
RUN set -eux; \
    duckdb_jdbc_version="${DUCKDB_JDBC_VERSION:?DUCKDB_JDBC_VERSION build-arg is required}"; \
    duckdb_jdbc_version="${duckdb_jdbc_version%%-*}"; \
    duckdb_cli_version="$(printf '%s' "${duckdb_jdbc_version}" | cut -d. -f1-3)"; \
    export DUCKDB_VERSION="${duckdb_cli_version}"; \
    curl https://install.duckdb.org | sh; \
    /root/.duckdb/cli/${duckdb_cli_version}/duckdb -c "INSTALL iceberg; INSTALL httpfs; INSTALL cache_httpfs FROM community;"; \
    mkdir -p "${DUCKDB_EXTENSIONS_DIR}"; \
    cp -a /root/.duckdb/extensions/. "${DUCKDB_EXTENSIONS_DIR}/"; \
    rm -rf /root/.duckdb
