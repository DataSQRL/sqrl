Customer.orders := JOIN Orders ON Orders.customerid = @.customerid;
Orders.entries.product := JOIN Product ON Product.productid = @.productid LIMIT 1;
Customer.recent_products := SELECT e.productid, e.product.category AS category,
                                   sum(e.quantity) AS quantity, count(1) AS num_orders
                            FROM @.orders.entries AS e
                            WHERE e.parent.time > now() - INTERVAL 2 YEAR
                            GROUP BY productid, category ORDER BY count(1) DESC, quantity DESC;


LogicalSort(sort0=[$0], sort1=[$4], sort2=[$3], dir0=[ASC], dir1=[DESC], dir2=[DESC])
  LogicalAggregate(group=[{0, 1, 2}], quantity=[SUM($3)], num_orders=[COUNT()])
    LogicalProject(__pk_0=[$0], productid=[$13], category=[$22], quantity=[$14])
      LogicalFilter(condition=[>($27, -(now(), 24:INTERVAL YEAR))])
        LogicalJoin(condition=[=($11, $23)], joinType=[left])
          LogicalJoin(condition=[=($19, $13)], joinType=[left])
            LogicalJoin(condition=[=($9, $2)], joinType=[default])
              LogicalTableScan(table=[[customer$3]])
              LogicalJoin(condition=[=($0, $5)], joinType=[default])
                LogicalTableScan(table=[[orders$12]])
                LogicalTableScan(table=[[entries$13]])
            LogicalTableScan(table=[[product$10]])
          LogicalTableScan(table=[[orders$12]])


SELECT "customer$3"."_uuid" AS "__pk_0", "entries$13"."productid", "product$10"."category", SUM("entries$13"."quantity") AS "quantity", COUNT(*) AS "num_orders"
FROM "customer$3"
 DEFAULT JOIN ("orders$12" DEFAULT JOIN "entries$13" ON "orders$12"."id" = "entries$13"."id") ON "customer$3"."customerid" = "orders$12"."customerid"
 LEFT JOIN "product$10" ON "entries$13"."productid" = "product$10"."productid"
 LEFT JOIN "orders$12" AS "orders$120" ON "entries$13"."id" = "orders$120"."id"
WHERE "orders$120"."time" > "now"() - INTERVAL '2' YEAR
GROUP BY "customer$3"."_uuid", "entries$13"."productid", "product$10"."category"
ORDER BY "customer$3"."_uuid", COUNT(*) DESC, SUM("entries$13"."quantity") DESC