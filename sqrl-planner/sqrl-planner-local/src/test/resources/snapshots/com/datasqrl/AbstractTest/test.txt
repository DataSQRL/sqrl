>>>Script
IMPORT mysourcepackage.Events AS ConferenceEvents TIMESTAMP last_updated AS timestamp;
IMPORT mysourcepackage.AuthTokens;
IMPORT mysourcepackage.EmailTemplates

IMPORT myAPI.EventUpdate TIMESTAMP _source_time AS timestamp;
IMPORT myAPI.Likes;
IMPORT myAPI.ReportEvent;
IMPORT myAPI.AddInterest;
IMPORT myAPI.EventRemoval;

IMPORT string.*;
IMPORT text.*;
IMPORT secure.randomID;

EmailTemplates := DISTINCT EmailTemplates ON id ORDER BY last_updated DESC;
AuthTokens := DISTINCT AuthTokens ON id ORDER BY last_updated DESC;

EventPosts := SELECT * FROM EventUpdate WHERE id IS NULL;

EventPosts.id := randomID(12);
EventPosts.secret := randomID(10);

EventPostEmail := SELECT e.email as toEmail, t.fromEmail, t.title,
                         format(t.textBody, e.name, e.id, e.secret) as textBody
                  FROM EventPosts e TEMPORAL JOIN EmailTemplates t ON t.id = 'confirmpost';

EXPORT EventPostEmail TO print.eventpostemail; --sink to queue and email sending

EventSecrets := DISTINCT EventPosts ON id ORDER BY timestamp DESC;

VerifiedEventUpdate := SELECT u.* FROM EventUpdate u TEMPORAL JOIN EventSecrets s ON u.id = s.id AND u.secret = s.secret;

AuthorizedEventRemoval := SELECT r.* FROM EventRemoval r TEMPORAL JOIN AuthTokens a ON a.id = 'removal' AND a.value = r.auth_token;

FilteredEventUpdate := SELECT v.*, coalesce(r._uuid, '') AS removalId, ((NOT bannedWordsFilter(v.name))
                            OR (NOT bannedWordsFilter(v.description)) OR (NOT bannedWordsFilter(v.location))) AS removed
                       FROM VerifiedEventUpdate v LEFT INTERVAL JOIN AuthorizedEventRemoval r ON v.id = r.eventId AND v.timestamp < r._source_time;

/* requires string aggregated concatenation
ConferenceEvents.speakerSummary := SELECT concatAgg( s.name + '(' + s.title + ' at ' + s.company + ')', ', ') as name
                                 FROM @.speakers s;
 */
/* Replace with above */
ConferenceEvents.speakerSummary := SELECT CONCAT('speakerlength', (sum(length(s.name) + length(s.title) + length(s.company)))) as name
                                   FROM @.speakers s;

ConferenceEventsFlat := SELECT e._uuid, e.timestamp, e.id, e.time, e.title, e.description, e.location, s.name as name
                        FROM ConferenceEvents e JOIN e.speakerSummary s;

Events := SELECT _uuid, removalId, timestamp, id, time, title, description, name, location, removed FROM FilteredEventUpdate
          UNION ALL
          SELECT _uuid, '' as removalId, timestamp, id, time, title, description, name, location, FALSE as removed FROM ConferenceEventsFlat;

EventNotification := SELECT * FROM FilteredEventUpdate WHERE NOT removed;

--Events.embedding := embed_text(title + description);
Events.embedding := length(description); -- replace by vector embedding

Events := DISTINCT Events ON id ORDER BY timestamp DESC;

--Interests.embedding := embed_text(text);
AddInterest.embedding := length(text); -- replace by vector embedding

UserInterests := SELECT userid, avg(embedding) as interestVector FROM AddInterest GROUP BY userid;

UserLikes := DISTINCT Likes ON userid, eventId ORDER BY _source_time DESC;


EventLikeCount := SELECT eventid, sum(liked) as num FROM UserLikes l GROUP BY eventid;
Events.likeCount := JOIN EventLikeCount l ON @.id = l.eventid;

EventsAfterTime(@afterTime: DateTime) := SELECT * FROM Events WHERE time > @afterTime AND NOT removed
                                                             ORDER BY time ASC;

EventSearch(@query: String, @afterTime: DateTime) := SELECT * FROM Events WHERE
                        time >= @afterTime AND textsearch(@query, title, description) > 0
                        AND NOT removed
                        ORDER BY textsearch(@query, title, description) DESC;

-- Events that the user liked or that are similar to users interests (requires vector search)

PersonalizedEvents(@userid: String, @tolerance: Float, @afterTime: DateTime) :=
SELECT e.*, l.liked,
       coalesce(l.eventId, '') as shouldRemove1,
       i.interestVector / e.embedding as score
--       cosineSimilarity(i.interestVector, e.embedding) as score
FROM Events e
    LEFT JOIN UserLikes l ON e.id = l.eventId AND l.userid = @userid
    LEFT JOIN UserInterests i ON i.userid = @userid
    WHERE e.time > @afterTime AND NOT removed
          AND (l.liked = 1 OR (i.interestVector IS NOT NULL AND
                               i.interestVector / CAST(e.embedding AS float) >= @tolerance))
--                               cosineSimilarity(i.interestVector, e.embedding) >= @tolerance))
    ORDER BY e.time ASC

--PersonalizedEvents.likeCount := JOIN EventLikeCount l ON @.id = l.eventid;


FlaggedEventEmail := SELECT t.toEmail, t.fromEmail, t.title,
                         format(t.textBody, r.eventid, e.title, e.description, e.name) as textBody
                  FROM ReportEvent r
                  TEMPORAL JOIN Events e ON r.eventid = e.id
                  TEMPORAL JOIN EmailTemplates t ON t.id = 'eventflag';

EXPORT FlaggedEventEmail TO print.flaggedEventEmail;

>>>Schema
scalar DateTime

type Query {
    PersonalizedEvents( userid: String!, tolerance: Float!, afterTime: DateTime!): [PersonalizedEvents!]
    EventsAfterTime(afterTime: DateTime!): [Events!]!
    EventSearch( query: String!, afterTime: DateTime!): [EventSearchResult!]!
}

interface AbstractEvents {
    String : Int!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
}

type LikeCount {
    num : Int
}

type EventSearchResult {
    id : String!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
}
type Events implements AbstractEvents{
    id : String!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
}

type PersonalizedEvents implements AbstractEvents{
    id : String!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
    liked: Int!
    score: Float!
}

type Subscription {
    EventNotification: Events
}


type Mutation {
    EventUpdate(event: EventUpdate!): EventUpdated
    Likes(liked: LikedInput!): CreatedLiked
    ReportEvent(report: EventReport!): EventReported
    AddInterest(interest: AddInterest!): InterestAdded
    EventRemoval(removal: EventRemoval!): EventRemoved
}

input EventUpdate {
    userid: String!
    id: String!
    name: String!
    email: String!
    location: String!
    time: DateTime!
    title: String!
    description: String!
    secret: String!
}

type EventUpdated {
    _source_time: String!
    userid: String!
}

input EventRemoval {
    eventId: String!
    auth_token: String!
}

type EventRemoved {
    _source_time: String!
}

input AddInterest {
    text: String!
    userid: String!
}

type InterestAdded {
    _source_time: String!
    userid: String!
}

input EventReport {
    eventId: String!
    userid: String!
}

type EventReported {
    _source_time: String!
    userid: String!
}

input LikedInput {
    eventId: String!
    userid: String!
    liked: Int!
}

type CreatedLiked {
    _source_time: String!
    userid: String!
}

>>>DDL


CREATE TABLE IF NOT EXISTS events$51 (id$0 VARCHAR NOT NULL,_uuid$0 VARCHAR NOT NULL,removalid$0 VARCHAR NOT NULL,timestamp$0 TIMESTAMPTZ NOT NULL,time$0 TIMESTAMPTZ NOT NULL,title$0 VARCHAR NOT NULL,description$0 VARCHAR NOT NULL,name$0 VARCHAR NOT NULL,location$0 VARCHAR NOT NULL,removed$0 BOOLEAN NOT NULL,embedding$0 BIGINT NOT NULL , PRIMARY KEY (id$0));
CREATE TABLE IF NOT EXISTS userinterests$53 (userid$0 VARCHAR NOT NULL,interestvector$0 BIGINT NOT NULL,_source_time$0 TIMESTAMPTZ NOT NULL , PRIMARY KEY (userid$0));
CREATE TABLE IF NOT EXISTS userlikes$55 (userid$0 VARCHAR NOT NULL,eventid$0 VARCHAR NOT NULL,_uuid$0 VARCHAR NOT NULL,_ingest_time$0 TIMESTAMPTZ NOT NULL,_source_time$0 TIMESTAMPTZ NOT NULL,liked$0 BIGINT NOT NULL , PRIMARY KEY (userid$0,eventid$0));
CREATE INDEX IF NOT EXISTS events$51_btree_c4 ON events$51 USING btree (time$0);
CREATE INDEX IF NOT EXISTS events$51_text_c5c6 ON events$51 USING GIN (to_tsvector('english', coalesce(title$0, '') || ' ' || coalesce(description$0, '') ));
Query:PersonalizedEvents(userid, tolerance, afterTime)  =  SELECT "id$0", COALESCE("eventid$0", '') AS "shouldRemove1", "_uuid$0", "removalid$0", "timestamp$0", "time$0", "title$0", "description$0", "name$0", "location$0", "removed$0", "embedding$0", "liked$0" AS "liked", "interestvector$0" / "embedding$0" AS "score", "__timestamp$0"
FROM (SELECT "t1"."id$0", "t1"."_uuid$0", "t1"."removalid$0", "t1"."timestamp$0", "t1"."time$0", "t1"."title$0", "t1"."description$0", "t1"."name$0", "t1"."location$0", "t1"."removed$0", "t1"."embedding$0", "t1"."userid$0", "t1"."eventid$0", "t1"."_uuid$00", "t1"."_ingest_time$0", "t1"."_source_time$0", "t1"."liked$0", "t1"."eventid$0$0", "t1"."eventid$0$1", "t1"."__timestamp", "t2"."userid$0" AS "userid$00", "t2"."interestvector$0", "t2"."_source_time$0" AS "_source_time$00", CASE WHEN "t1"."__timestamp" < "t2"."_source_time$0" THEN "t2"."_source_time$0" ELSE "t1"."__timestamp" END AS "__timestamp$0"
  FROM (SELECT *
    FROM (SELECT "events$51"."id$0", "events$51"."_uuid$0", "events$51"."removalid$0", "events$51"."timestamp$0", "events$51"."time$0", "events$51"."title$0", "events$51"."description$0", "events$51"."name$0", "events$51"."location$0", "events$51"."removed$0", "events$51"."embedding$0", "t"."userid$0", "t"."eventid$0", "t"."_uuid$0" AS "_uuid$00", "t"."_ingest_time$0", "t"."_source_time$0", "t"."liked$0", "t"."eventid$0$0", "t"."eventid$0$1", CASE WHEN "events$51"."timestamp$0" < "t"."_source_time$0" THEN "t"."_source_time$0" ELSE "events$51"."timestamp$0" END AS "__timestamp"
      FROM "events$51"
       LEFT JOIN (SELECT "userid$0", "eventid$0", "_uuid$0", "_ingest_time$0", "_source_time$0", "liked$0", CAST("eventid$0" AS VARCHAR(65536)) AS "eventid$0$0", CAST("eventid$0" AS VARCHAR(10485760)) AS "eventid$0$1"
        FROM "userlikes$55") AS "t" ON "events$51"."id$0" = "t"."eventid$0$1" AND "t"."userid$0" = $1) AS "t0"
    WHERE "t0"."time$0" > $3 AND NOT "t0"."removed$0") AS "t1"
   LEFT JOIN (SELECT *
    FROM "userinterests$53"
    WHERE "userid$0" = $1) AS "t2" ON TRUE) AS "t3"
WHERE "t3"."liked$0" = 1 OR "t3"."interestvector$0" / CAST("t3"."embedding$0" AS FLOAT) >= $2
ORDER BY "time$0", "id$0", COALESCE("eventid$0", '')

Query:EventsAfterTime(afterTime)  =  SELECT *
FROM "events$51"
WHERE "time$0" > $1 AND NOT "removed$0"
ORDER BY "time$0", "id$0"

Query:EventSearch(query, afterTime)  =  SELECT *
FROM "events$51"
WHERE "time$0" >= $2 AND (TO_TSVECTOR("title$0") @@ TO_TSQUERY(CAST($1 AS VARCHAR(65536))) AND TS_RANK_CD("title$0", CAST($1 AS VARCHAR(65536))) > 0) AND NOT "removed$0"
ORDER BY "id$0"

>>>Queries


query$1 = SELECT *
FROM (SELECT `id$1`, `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `timestamp$0`, `secret$1`, ROW_NUMBER() OVER (PARTITION BY `id$1` ORDER BY `timestamp$0` DESC NULLS LAST) AS `$f13`
  FROM (SELECT RANDOMID(12) AS `id$1`, `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `timestamp$0`, RANDOMID(10) AS `secret$1`
    FROM (VALUES  (NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)) AS `t` (`_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`)
    WHERE 1 = 0) AS `t1`) AS `t2`
WHERE `$f13` = 1

query$2 = SELECT *
FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `value$0`, `last_updated$0`, ROW_NUMBER() OVER (PARTITION BY `id$0` ORDER BY `last_updated$0` DESC NULLS LAST) AS `$f5`
  FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `value$0`, `last_updated$0`
    FROM `authtokens$i$5`) AS `t7`) AS `t8`
WHERE `$f5` = 1

query$3 = SELECT `$cor3`.`_uuid$0` AS `___uuid$0$pk$1`, CHAR_LENGTH(`t160`.`name$0`) + CHAR_LENGTH(`t160`.`title$0`) + CHAR_LENGTH(`t160`.`company$0`) AS `$f0`, `t160`.`_idx$0`, `$cor3`.`timestamp$0`
FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
  FROM `conferenceevents$i$1`) AS `$cor3`,
 UNNEST(`$cor3`.`speakers$0`) AS `t160`

root$4 = SELECT `id$0`, `_uuid$0`, `removalId` AS `removalid$0`, `timestamp$0`, `time$0`, `title$0`, `description$0`, `name$0`, `location$0`, `removed` AS `removed$0`, CHAR_LENGTH(`description$0`) AS `embedding$0`
FROM (SELECT `t6`.`_uuid$0`, COALESCE(`t10`.`_uuid$0`, '') AS `removalId`, `t6`.`timestamp$0`, `t6`.`id$0`, `t6`.`time$0`, `t6`.`title$0`, `t6`.`description$0`, `t6`.`name$0`, `t6`.`location$0`, NOT BANNEDWORDSFILTER(`t6`.`name$0`) OR NOT BANNEDWORDSFILTER(`t6`.`description$0`) OR NOT BANNEDWORDSFILTER(`t6`.`location$0`) AS `removed`
   FROM (SELECT `$cor4`.`_uuid$0`, `$cor4`.`_ingest_time$0`, `$cor4`.`_source_time$0`, `$cor4`.`userid$0`, `$cor4`.`id$0`, `$cor4`.`name$0`, `$cor4`.`email$0`, `$cor4`.`location$0`, `$cor4`.`time$0`, `$cor4`.`title$0`, `$cor4`.`description$0`, `$cor4`.`secret$0`, `$cor4`.`timestamp$0`
     FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
       FROM `eventupdate$i$11`) AS `$cor4`
      INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor4`.`timestamp$0` AS `t3` ON `$cor4`.`id$0$0` = `t3`.`id$1` AND `$cor4`.`secret$0$0` = `t3`.`secret$1`) AS `t6`
    LEFT JOIN (SELECT `$cor5`.`_uuid$0`, `$cor5`.`_ingest_time$0`, `$cor5`.`_source_time$0`, `$cor5`.`eventid$0`, `$cor5`.`auth_token$0`
     FROM `eventremoval$i$23` AS `$cor5`
      INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor5`.`_source_time$0` AS `t9` ON `t9`.`id$0` = 'removal' AND `t9`.`value$0` = `$cor5`.`auth_token$0`) AS `t10` ON `t6`.`id$0` = `t10`.`eventid$0` AND `t6`.`timestamp$0` < `t10`.`_source_time$0` AND `t10`.`_source_time$0` < (`t6`.`timestamp$0` + INTERVAL '31504464' SECOND(11))
   UNION ALL
   SELECT `t13`.`_uuid$0` AS `_uuid`, '' AS `removalId`, `t13`.`timestamp$0` AS `timestamp`, CAST(`t13`.`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `EXPR$3`, `t13`.`time$0` AS `time`, `t13`.`title$0` AS `title`, `t13`.`description$0` AS `description`, `t21`.`name`, `t13`.`location$0` AS `location`, FALSE AS `removed`
   FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
     FROM `conferenceevents$i$1`) AS `t13`
    INNER JOIN (SELECT `___uuid$0$pk$1`, CONCAT('speakerlength', SUM(`$f0`)) AS `name`, `window_time` AS `timestamp$0`
     FROM TABLE(TUMBLE(TABLE `query$3`, DESCRIPTOR(`timestamp$0`), INTERVAL '0.001' SECOND(1))) AS `t18`
     GROUP BY `___uuid$0$pk$1`, `window_start`, `window_end`, `window_time`) AS `t21` ON `t13`.`_uuid$0` = `t21`.`___uuid$0$pk$1` AND `t13`.`timestamp$0` = `t21`.`timestamp$0`) AS `t24`

root$5 = SELECT `userid$0`, AVG(`embedding$0`) OVER (PARTITION BY `userid$0` ORDER BY `_source_time$0` ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `interestvector$0`, `_source_time$0`
FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `text$0`, `userid$0`, CHAR_LENGTH(`text$0`) AS `embedding$0`
  FROM `addinterest$i$20`) AS `t28`

root$6 = SELECT `userid$0`, `eventid$0`, `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `liked$0`
FROM `likes$i$14`

root$7 = SELECT `_uuid$0`, `removalId` AS `removalid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, `removed` AS `removed$0`
FROM (SELECT `t40`.`_uuid$0`, COALESCE(`t44`.`_uuid$0`, '') AS `removalId`, `t40`.`_ingest_time$0`, `t40`.`_source_time$0`, `t40`.`userid$0`, `t40`.`id$0`, `t40`.`name$0`, `t40`.`email$0`, `t40`.`location$0`, `t40`.`time$0`, `t40`.`title$0`, `t40`.`description$0`, `t40`.`secret$0`, `t40`.`timestamp$0`, NOT BANNEDWORDSFILTER(`t40`.`name$0`) OR NOT BANNEDWORDSFILTER(`t40`.`description$0`) OR NOT BANNEDWORDSFILTER(`t40`.`location$0`) AS `removed`
  FROM (SELECT `$cor6`.`_uuid$0`, `$cor6`.`_ingest_time$0`, `$cor6`.`_source_time$0`, `$cor6`.`userid$0`, `$cor6`.`id$0`, `$cor6`.`name$0`, `$cor6`.`email$0`, `$cor6`.`location$0`, `$cor6`.`time$0`, `$cor6`.`title$0`, `$cor6`.`description$0`, `$cor6`.`secret$0`, `$cor6`.`timestamp$0`
    FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
      FROM `eventupdate$i$11`) AS `$cor6`
     INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor6`.`timestamp$0` AS `t37` ON `$cor6`.`id$0$0` = `t37`.`id$1` AND `$cor6`.`secret$0$0` = `t37`.`secret$1`) AS `t40`
   LEFT JOIN (SELECT `$cor7`.`_uuid$0`, `$cor7`.`_ingest_time$0`, `$cor7`.`_source_time$0`, `$cor7`.`eventid$0`, `$cor7`.`auth_token$0`
    FROM `eventremoval$i$23` AS `$cor7`
     INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor7`.`_source_time$0` AS `t43` ON `t43`.`id$0` = 'removal' AND `t43`.`value$0` = `$cor7`.`auth_token$0`) AS `t44` ON `t40`.`id$0` = `t44`.`eventid$0` AND `t40`.`timestamp$0` < `t44`.`_source_time$0` AND `t44`.`_source_time$0` < (`t40`.`timestamp$0` + INTERVAL '31504464' SECOND(11))) AS `t45`
WHERE NOT `t45`.`removed`

query$8 = SELECT *
FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `last_updated$0`, `title$0`, `fromemail$0`, `toemail$0`, `textbody$0`, ROW_NUMBER() OVER (PARTITION BY `id$0` ORDER BY `last_updated$0` DESC NULLS LAST) AS `$f8`
  FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `last_updated$0`, `title$0`, `fromemail$0`, `toemail$0`, `textbody$0`
    FROM `emailtemplates$i$8`) AS `t49`) AS `t50`
WHERE `$f8` = 1

root$9 = SELECT `$cor8`.`_uuid$0`, `$cor8`.`email$0` AS `toemail$0`, `t51`.`fromemail$0`, `t51`.`title$0`, FORMAT(`t51`.`textbody$0`, `$cor8`.`name$0`, `$cor8`.`id$1`, `$cor8`.`secret$1`) AS `textbody$0`, `$cor8`.`timestamp$0`
FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, RANDOMID(12) AS `id$1`, RANDOMID(10) AS `secret$1`
  FROM (VALUES  (NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)) AS `t` (`_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`)
  WHERE 1 = 0) AS `$cor8`
 INNER JOIN `query$8` FOR SYSTEM_TIME AS OF `$cor8`.`timestamp$0` AS `t51` ON `t51`.`id$0` = 'confirmpost'

query$10 = SELECT *
FROM (SELECT `id`, `_uuid`, `removalId`, `timestamp`, `time`, `title`, `description`, `name`, `location`, `removed`, `embedding$0`, ROW_NUMBER() OVER (PARTITION BY `id` ORDER BY `timestamp` DESC NULLS LAST) AS `$f11`
  FROM (SELECT `id$0` AS `id`, `_uuid$0` AS `_uuid`, `removalId`, `timestamp$0` AS `timestamp`, `time$0` AS `time`, `title$0` AS `title`, `description$0` AS `description`, `name$0` AS `name`, `location$0` AS `location`, `removed`, CHAR_LENGTH(`description$0`) AS `embedding$0`
    FROM (SELECT `t66`.`_uuid$0`, COALESCE(`t70`.`_uuid$0`, '') AS `removalId`, `t66`.`timestamp$0`, `t66`.`id$0`, `t66`.`time$0`, `t66`.`title$0`, `t66`.`description$0`, `t66`.`name$0`, `t66`.`location$0`, NOT BANNEDWORDSFILTER(`t66`.`name$0`) OR NOT BANNEDWORDSFILTER(`t66`.`description$0`) OR NOT BANNEDWORDSFILTER(`t66`.`location$0`) AS `removed`
       FROM (SELECT `$cor11`.`_uuid$0`, `$cor11`.`_ingest_time$0`, `$cor11`.`_source_time$0`, `$cor11`.`userid$0`, `$cor11`.`id$0`, `$cor11`.`name$0`, `$cor11`.`email$0`, `$cor11`.`location$0`, `$cor11`.`time$0`, `$cor11`.`title$0`, `$cor11`.`description$0`, `$cor11`.`secret$0`, `$cor11`.`timestamp$0`
         FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
           FROM `eventupdate$i$11`) AS `$cor11`
          INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor11`.`timestamp$0` AS `t63` ON `$cor11`.`id$0$0` = `t63`.`id$1` AND `$cor11`.`secret$0$0` = `t63`.`secret$1`) AS `t66`
        LEFT JOIN (SELECT `$cor12`.`_uuid$0`, `$cor12`.`_ingest_time$0`, `$cor12`.`_source_time$0`, `$cor12`.`eventid$0`, `$cor12`.`auth_token$0`
         FROM `eventremoval$i$23` AS `$cor12`
          INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor12`.`_source_time$0` AS `t69` ON `t69`.`id$0` = 'removal' AND `t69`.`value$0` = `$cor12`.`auth_token$0`) AS `t70` ON `t66`.`id$0` = `t70`.`eventid$0` AND `t66`.`timestamp$0` < `t70`.`_source_time$0` AND `t70`.`_source_time$0` < (`t66`.`timestamp$0` + INTERVAL '31504464' SECOND(11))
       UNION ALL
       SELECT `t73`.`_uuid$0` AS `_uuid`, '' AS `removalId`, `t73`.`timestamp$0` AS `timestamp`, CAST(`t73`.`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `EXPR$3`, `t73`.`time$0` AS `time`, `t73`.`title$0` AS `title`, `t73`.`description$0` AS `description`, `t81`.`name`, `t73`.`location$0` AS `location`, FALSE AS `removed`
       FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
         FROM `conferenceevents$i$1`) AS `t73`
        INNER JOIN (SELECT `___uuid$0$pk$1`, CONCAT('speakerlength', SUM(`$f0`)) AS `name`, `window_time` AS `timestamp$0`
         FROM TABLE(TUMBLE(TABLE `query$3`, DESCRIPTOR(`timestamp$0`), INTERVAL '0.001' SECOND(1))) AS `t78`
         GROUP BY `___uuid$0$pk$1`, `window_start`, `window_end`, `window_time`) AS `t81` ON `t73`.`_uuid$0` = `t81`.`___uuid$0$pk$1` AND `t73`.`timestamp$0` = `t81`.`timestamp$0`) AS `t84`) AS `t86`) AS `t87`
WHERE `$f11` = 1

root$11 = SELECT `$cor9`.`_uuid$0`, `t58`.`toemail$0`, `t58`.`fromemail$0`, `t58`.`title$0`, FORMAT(`t58`.`textbody$0`, `$cor9`.`eventid$0`, `$cor9`.`title`, `$cor9`.`description`, `$cor9`.`name`) AS `textbody$0`, `$cor9`.`_source_time$0`
FROM (SELECT *
  FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `eventid$0`, `userid$0`, CAST(`eventid$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `eventid$0$0`
    FROM `reportevent$i$17`) AS `$cor10`
   INNER JOIN `query$10` FOR SYSTEM_TIME AS OF `$cor10`.`_source_time$0` AS `t88` ON `$cor10`.`eventid$0$0` = `t88`.`id`) AS `$cor9`
 INNER JOIN `query$8` FOR SYSTEM_TIME AS OF `$cor9`.`_source_time$0` AS `t58` ON `t58`.`id$0` = 'eventflag'

