>>>Script
IMPORT mysourcepackage.Events AS ConferenceEvents TIMESTAMP last_updated AS timestamp;
IMPORT mysourcepackage.AuthTokens;
IMPORT mysourcepackage.EmailTemplates

IMPORT myAPI.EventUpdate TIMESTAMP _source_time AS timestamp;
IMPORT myAPI.Likes;
IMPORT myAPI.ReportEvent;
IMPORT myAPI.AddInterest;
IMPORT myAPI.EventRemoval;

IMPORT string.*;
IMPORT text.*;
IMPORT secure.randomID;

EmailTemplates := DISTINCT EmailTemplates ON id ORDER BY last_updated DESC;
AuthTokens := DISTINCT AuthTokens ON id ORDER BY last_updated DESC;

EventPosts := SELECT * FROM EventUpdate WHERE id IS NULL;

EventPosts.id := randomID(12);
EventPosts.secret := randomID(10);

EventPostEmail := SELECT e.email as toEmail, t.fromEmail, t.title,
                         format(t.textBody, e.name, e.id, e.secret) as textBody
                  FROM EventPosts e TEMPORAL JOIN EmailTemplates t ON t.id = 'confirmpost';

EXPORT EventPostEmail TO print.eventpostemail; --sink to queue and email sending

EventSecrets := DISTINCT EventPosts ON id ORDER BY timestamp DESC;

VerifiedEventUpdate := SELECT u.* FROM EventUpdate u TEMPORAL JOIN EventSecrets s ON u.id = s.id AND u.secret = s.secret;

AuthorizedEventRemoval := SELECT r.* FROM EventRemoval r TEMPORAL JOIN AuthTokens a ON a.id = 'removal' AND a.value = r.auth_token;

FilteredEventUpdate := SELECT v.*, coalesce(r._uuid, '') AS removalId, ((NOT bannedWordsFilter(v.name))
                            OR (NOT bannedWordsFilter(v.description)) OR (NOT bannedWordsFilter(v.location))) AS removed
                       FROM VerifiedEventUpdate v LEFT INTERVAL JOIN AuthorizedEventRemoval r ON v.id = r.eventId AND v.timestamp < r._source_time;

/* requires string aggregated concatenation
ConferenceEvents.speakerSummary := SELECT concatAgg( s.name + '(' + s.title + ' at ' + s.company + ')', ', ') as name
                                 FROM @.speakers s;
 */
/* Replace with above */
ConferenceEvents.speakerSummary := SELECT CONCAT('speakerlength', (sum(length(s.name) + length(s.title) + length(s.company)))) as name
                                   FROM @.speakers s;

ConferenceEventsFlat := SELECT e._uuid, e.timestamp, e.id, e.time, e.title, e.description, e.location, s.name as name
                        FROM ConferenceEvents e JOIN e.speakerSummary s;

Events := SELECT _uuid, removalId, timestamp, id, time, title, description, name, location, removed FROM FilteredEventUpdate
          UNION ALL
          SELECT _uuid, '' as removalId, timestamp, id, time, title, description, name, location, FALSE as removed FROM ConferenceEventsFlat;

EventNotification := SELECT * FROM FilteredEventUpdate WHERE NOT removed;

--Events.embedding := embed_text(title + description);
Events.embedding := length(description); -- replace by vector embedding

Events := DISTINCT Events ON id ORDER BY timestamp DESC;

--Interests.embedding := embed_text(text);
AddInterest.embedding := length(text); -- replace by vector embedding

UserInterests := SELECT userid, avg(embedding) as interestVector FROM AddInterest GROUP BY userid;

UserLikes := DISTINCT Likes ON userid, eventId ORDER BY _source_time DESC;


EventLikeCount := SELECT eventid, sum(liked) as num FROM UserLikes l GROUP BY eventid;
Events.likeCount := JOIN EventLikeCount l ON @.id = l.eventid;

EventsAfterTime(@afterTime: DateTime) := SELECT * FROM Events WHERE time > @afterTime AND NOT removed
                                                             ORDER BY time ASC;

EventSearch(@query: String, @afterTime: DateTime) := SELECT * FROM Events WHERE
                        time >= @afterTime AND textsearch(@query, title, description) > 0
                        AND NOT removed
;
-- Events that the user liked or that are similar to users interests (requires vector search)

PersonalizedEvents(@userid: String, @tolerance: Float, @afterTime: DateTime) :=
SELECT e.*, l.liked,
       coalesce(l.eventId, '') as shouldRemove1,
       i.interestVector / e.embedding as score
--       cosineSimilarity(i.interestVector, e.embedding) as score
FROM Events e
    LEFT JOIN UserLikes l ON e.id = l.eventId AND l.userid = @userid
    LEFT JOIN UserInterests i ON i.userid = @userid
    WHERE e.time > @afterTime AND NOT removed
          AND (l.liked = 1 OR (i.interestVector IS NOT NULL AND
                               i.interestVector / e.embedding >= @tolerance))
--                               cosineSimilarity(i.interestVector, e.embedding) >= @tolerance))
    ORDER BY e.time ASC

--PersonalizedEvents.likeCount := JOIN EventLikeCount l ON @.id = l.eventid;


FlaggedEventEmail := SELECT t.toEmail, t.fromEmail, t.title,
                         format(t.textBody, r.eventid, e.title, e.description, e.name) as textBody
                  FROM ReportEvent r
                  TEMPORAL JOIN Events e ON r.eventid = e.id
                  TEMPORAL JOIN EmailTemplates t ON t.id = 'eventflag';

EXPORT FlaggedEventEmail TO print.flaggedEventEmail;

>>>Schema
scalar DateTime

type Query {
    PersonalizedEvents( userid: String!, tolerance: Float!, afterTime: DateTime!): [PersonalizedEvents!]
    EventsAfterTime(afterTime: DateTime!): [Events!]!
    EventSearch( query: String!, afterTime: DateTime!): [EventSearchResult!]!
}

interface AbstractEvents {
    String : Int!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
}

type LikeCount {
    num : Int
}

type EventSearchResult {
    id : String!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
}
type Events implements AbstractEvents{
    id : String!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
}

type PersonalizedEvents implements AbstractEvents{
    id : String!
    time : String!
    location: String!
    title : String!
    description : String!
    name : String!
    liked: Int!
    score: Float!
}

type Subscription {
    EventNotification: Events
}


type Mutation {
    EventUpdate(event: EventUpdate!): EventUpdated
    Likes(liked: LikedInput!): CreatedLiked
    ReportEvent(report: EventReport!): EventReported
    AddInterest(interest: AddInterest!): InterestAdded
    EventRemoval(removal: EventRemoval!): EventRemoved
}

input EventUpdate {
    userid: String!
    id: String!
    name: String!
    email: String!
    location: String!
    time: DateTime!
    title: String!
    description: String!
    secret: String!
}

type EventUpdated {
    _source_time: String!
    userid: String!
}

input EventRemoval {
    eventId: String!
    auth_token: String!
}

type EventRemoved {
    _source_time: String!
}

input AddInterest {
    text: String!
    userid: String!
}

type InterestAdded {
    _source_time: String!
    userid: String!
}

input EventReport {
    eventId: String!
    userid: String!
}

type EventReported {
    _source_time: String!
    userid: String!
}

input LikedInput {
    eventId: String!
    userid: String!
    liked: Int!
}

type CreatedLiked {
    _source_time: String!
    userid: String!
}

>>>DDL


CREATE TABLE IF NOT EXISTS events$51 (id$0 VARCHAR NOT NULL,_uuid$0 VARCHAR NOT NULL,removalid$0 VARCHAR NOT NULL,timestamp$0 TIMESTAMPTZ NOT NULL,time$0 TIMESTAMPTZ NOT NULL,title$0 VARCHAR NOT NULL,description$0 VARCHAR NOT NULL,name$0 VARCHAR NOT NULL,location$0 VARCHAR NOT NULL,removed$0 BOOLEAN NOT NULL,embedding$0 BIGINT NOT NULL , PRIMARY KEY (id$0));
CREATE TABLE IF NOT EXISTS eventsaftertime$59 (id$0 VARCHAR NOT NULL,_uuid$0 VARCHAR NOT NULL,removalid$0 VARCHAR NOT NULL,timestamp$0 TIMESTAMPTZ NOT NULL,time$0 TIMESTAMPTZ NOT NULL,title$0 VARCHAR NOT NULL,description$0 VARCHAR NOT NULL,name$0 VARCHAR NOT NULL,location$0 VARCHAR NOT NULL,removed$0 BOOLEAN NOT NULL,embedding$0 BIGINT NOT NULL , PRIMARY KEY (id$0));
CREATE TABLE IF NOT EXISTS eventsearch$61 (id$0 VARCHAR NOT NULL,_uuid$0 VARCHAR NOT NULL,removalid$0 VARCHAR NOT NULL,timestamp$0 TIMESTAMPTZ NOT NULL,time$0 TIMESTAMPTZ NOT NULL,title$0 VARCHAR NOT NULL,description$0 VARCHAR NOT NULL,name$0 VARCHAR NOT NULL,location$0 VARCHAR NOT NULL,removed$0 BOOLEAN NOT NULL,embedding$0 BIGINT NOT NULL , PRIMARY KEY (id$0));
CREATE TABLE IF NOT EXISTS userinterests$53 (userid$0 VARCHAR NOT NULL,interestvector$0 BIGINT NOT NULL,_source_time$0 TIMESTAMPTZ NOT NULL , PRIMARY KEY (userid$0));
CREATE TABLE IF NOT EXISTS userlikes$55 (userid$0 VARCHAR NOT NULL,eventid$0 VARCHAR NOT NULL,_uuid$0 VARCHAR NOT NULL,_ingest_time$0 TIMESTAMPTZ NOT NULL,_source_time$0 TIMESTAMPTZ NOT NULL,liked$0 BIGINT NOT NULL , PRIMARY KEY (userid$0,eventid$0));
CREATE INDEX IF NOT EXISTS events$51_btree_c4 ON events$51 USING btree (time$0);
Query:PersonalizedEvents(userid, tolerance, afterTime)  =  SELECT *
FROM (SELECT "id$0", COALESCE("eventid$0", '') AS "shouldremove1$0", "_uuid$0", "removalid$0", "timestamp$0", "time$0", "title$0", "description$0", "name$0", "location$0", "removed$0", "embedding$0", "liked$0", "interestvector$0" / "embedding$0" AS "score$0", "__timestamp$0"
  FROM (SELECT "t3"."id$0", "t3"."_uuid$0", "t3"."removalid$0", "t3"."timestamp$0", "t3"."time$0", "t3"."title$0", "t3"."description$0", "t3"."name$0", "t3"."location$0", "t3"."removed$0", "t3"."embedding$0", "t3"."userid$0", "t3"."eventid$0", "t3"."_uuid$00", "t3"."_ingest_time$0", "t3"."_source_time$0", "t3"."liked$0", "t3"."eventid$0$0", "t3"."__timestamp", "t6"."userid$0" AS "userid$00", "t6"."interestvector$0", "t6"."_source_time$0" AS "_source_time$00", "t6"."$f3", CASE WHEN "t3"."__timestamp" < "t6"."_source_time$0" THEN "t6"."_source_time$0" ELSE "t3"."__timestamp" END AS "__timestamp$0"
    FROM (SELECT *
      FROM (SELECT "events$51"."id$0", "events$51"."_uuid$0", "events$51"."removalid$0", "events$51"."timestamp$0", "events$51"."time$0", "events$51"."title$0", "events$51"."description$0", "events$51"."name$0", "events$51"."location$0", "events$51"."removed$0", "events$51"."embedding$0", "t1"."userid$0", "t1"."eventid$0", "t1"."_uuid$0" AS "_uuid$00", "t1"."_ingest_time$0", "t1"."_source_time$0", "t1"."liked$0", "t1"."eventid$0$0", CASE WHEN "events$51"."timestamp$0" < "t1"."_source_time$0" THEN "t1"."_source_time$0" ELSE "events$51"."timestamp$0" END AS "__timestamp"
        FROM "events$51"
         LEFT JOIN (SELECT "userid$0", "eventid$0", "_uuid$0", "_ingest_time$0", "_source_time$0", "liked$0", CAST("eventid$0" AS VARCHAR(10485760)) AS "eventid$0$0"
          FROM (SELECT "userid$0", "eventid$0", "_uuid$0", "_ingest_time$0", "_source_time$0", "liked$0", ROW_NUMBER() OVER (PARTITION BY "userid$0", "eventid$0" ORDER BY "_source_time$0" DESC NULLS LAST) AS "$f6"
            FROM "userlikes$55") AS "t"
          WHERE "$f6" = 1) AS "t1" ON "events$51"."id$0" = "t1"."eventid$0$0" AND "t1"."userid$0" = $1) AS "t2"
      WHERE "t2"."time$0" > $3 AND NOT "t2"."removed$0") AS "t3"
     LEFT JOIN (SELECT *
      FROM (SELECT *
        FROM (SELECT "userid$0", "interestvector$0", "_source_time$0", ROW_NUMBER() OVER (PARTITION BY "userid$0" ORDER BY "_source_time$0" DESC NULLS LAST) AS "$f3"
          FROM "userinterests$53") AS "t4"
        WHERE "$f3" = 1) AS "t5"
      WHERE "userid$0" = $1) AS "t6" ON TRUE) AS "t7"
  WHERE "t7"."liked$0" = 1 OR "t7"."interestvector$0" / "t7"."embedding$0" >= $2
  ORDER BY "time$0", "id$0", COALESCE("eventid$0", '')) AS "t11"

Query:EventsAfterTime(afterTime)  =  SELECT *
FROM (SELECT "id$0", "_uuid$0", "removalid$0", "timestamp$0", "time$0", "title$0", "description$0", "name$0", "location$0", "removed$0", "embedding$0"
  FROM "eventsaftertime$59"
  ORDER BY "time$0", "id$0") AS "t0"

Query:EventSearch(query, afterTime)  =  SELECT *
FROM (SELECT "id$0", "_uuid$0", "removalid$0", "timestamp$0", "time$0", "title$0", "description$0", "name$0", "location$0", "removed$0", "embedding$0"
  FROM "eventsearch$61"
  ORDER BY "id$0") AS "t0"

>>>Queries


query$1 = SELECT *
FROM (SELECT `id$1`, `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `timestamp$0`, `secret$1`, ROW_NUMBER() OVER (PARTITION BY `id$1` ORDER BY `timestamp$0` DESC NULLS LAST) AS `$f13`
  FROM (SELECT RANDOMID(12) AS `id$1`, `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `timestamp$0`, RANDOMID(10) AS `secret$1`
    FROM (VALUES  (NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)) AS `t` (`_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`)
    WHERE 1 = 0) AS `t1`) AS `t2`
WHERE `$f13` = 1

query$2 = SELECT *
FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `value$0`, `last_updated$0`, ROW_NUMBER() OVER (PARTITION BY `id$0` ORDER BY `last_updated$0` DESC NULLS LAST) AS `$f5`
  FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `value$0`, `last_updated$0`
    FROM `authtokens$i$5`) AS `t7`) AS `t8`
WHERE `$f5` = 1

query$3 = SELECT `$cor3`.`_uuid$0` AS `___uuid$0$pk$1`, CHAR_LENGTH(`t160`.`name$0`) + CHAR_LENGTH(`t160`.`title$0`) + CHAR_LENGTH(`t160`.`company$0`) AS `$f0`, `t160`.`_idx$0`, `$cor3`.`timestamp$0`
FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
  FROM `conferenceevents$i$1`) AS `$cor3`,
 UNNEST(`$cor3`.`speakers$0`) AS `t160`

root$4 = SELECT `id$0`, `_uuid$0`, `removalId` AS `removalid$0`, `timestamp$0`, `time$0`, `title$0`, `description$0`, `name$0`, `location$0`, `removed` AS `removed$0`, CHAR_LENGTH(`description$0`) AS `embedding$0`
FROM (SELECT `t6`.`_uuid$0`, COALESCE(`t10`.`_uuid$0`, '') AS `removalId`, `t6`.`timestamp$0`, `t6`.`id$0`, `t6`.`time$0`, `t6`.`title$0`, `t6`.`description$0`, `t6`.`name$0`, `t6`.`location$0`, NOT BANNEDWORDSFILTER(`t6`.`name$0`) OR NOT BANNEDWORDSFILTER(`t6`.`description$0`) OR NOT BANNEDWORDSFILTER(`t6`.`location$0`) AS `removed`
   FROM (SELECT `$cor4`.`_uuid$0`, `$cor4`.`_ingest_time$0`, `$cor4`.`_source_time$0`, `$cor4`.`userid$0`, `$cor4`.`id$0`, `$cor4`.`name$0`, `$cor4`.`email$0`, `$cor4`.`location$0`, `$cor4`.`time$0`, `$cor4`.`title$0`, `$cor4`.`description$0`, `$cor4`.`secret$0`, `$cor4`.`timestamp$0`
     FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
       FROM `eventupdate$i$11`) AS `$cor4`
      INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor4`.`timestamp$0` AS `t3` ON `$cor4`.`id$0$0` = `t3`.`id$1` AND `$cor4`.`secret$0$0` = `t3`.`secret$1`) AS `t6`
    LEFT JOIN (SELECT `$cor5`.`_uuid$0`, `$cor5`.`_ingest_time$0`, `$cor5`.`_source_time$0`, `$cor5`.`eventid$0`, `$cor5`.`auth_token$0`
     FROM `eventremoval$i$23` AS `$cor5`
      INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor5`.`_source_time$0` AS `t9` ON `t9`.`id$0` = 'removal' AND `t9`.`value$0` = `$cor5`.`auth_token$0`) AS `t10` ON `t6`.`id$0` = `t10`.`eventid$0` AND `t6`.`timestamp$0` < `t10`.`_source_time$0` AND `t10`.`_source_time$0` < (`t6`.`timestamp$0` + INTERVAL '31504464' SECOND(11))
   UNION ALL
   SELECT `t13`.`_uuid$0` AS `_uuid`, '' AS `removalId`, `t13`.`timestamp$0` AS `timestamp`, CAST(`t13`.`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `EXPR$3`, `t13`.`time$0` AS `time`, `t13`.`title$0` AS `title`, `t13`.`description$0` AS `description`, `t21`.`name`, `t13`.`location$0` AS `location`, FALSE AS `removed`
   FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
     FROM `conferenceevents$i$1`) AS `t13`
    INNER JOIN (SELECT `___uuid$0$pk$1`, CONCAT('speakerlength', SUM(`$f0`)) AS `name`, `window_time` AS `timestamp$0`
     FROM TABLE(TUMBLE(TABLE `query$3`, DESCRIPTOR(`timestamp$0`), INTERVAL '0.001' SECOND(1))) AS `t18`
     GROUP BY `___uuid$0$pk$1`, `window_start`, `window_end`, `window_time`) AS `t21` ON `t13`.`_uuid$0` = `t21`.`___uuid$0$pk$1` AND `t13`.`timestamp$0` = `t21`.`timestamp$0`) AS `t24`

root$5 = SELECT `id` AS `id$0`, `_uuid` AS `_uuid$0`, `removalId` AS `removalid$0`, `timestamp` AS `timestamp$0`, `time` AS `time$0`, `title` AS `title$0`, `description` AS `description$0`, `name` AS `name$0`, `location` AS `location$0`, `removed` AS `removed$0`, `embedding$0`
FROM (SELECT *
  FROM (SELECT `id`, `_uuid`, `removalId`, `timestamp`, `time`, `title`, `description`, `name`, `location`, `removed`, `embedding$0`, ROW_NUMBER() OVER (PARTITION BY `id` ORDER BY `timestamp` DESC NULLS LAST) AS `$f11`
    FROM (SELECT `id$0` AS `id`, `_uuid$0` AS `_uuid`, `removalId`, `timestamp$0` AS `timestamp`, `time$0` AS `time`, `title$0` AS `title`, `description$0` AS `description`, `name$0` AS `name`, `location$0` AS `location`, `removed`, CHAR_LENGTH(`description$0`) AS `embedding$0`
      FROM (SELECT `t35`.`_uuid$0`, COALESCE(`t39`.`_uuid$0`, '') AS `removalId`, `t35`.`timestamp$0`, `t35`.`id$0`, `t35`.`time$0`, `t35`.`title$0`, `t35`.`description$0`, `t35`.`name$0`, `t35`.`location$0`, NOT BANNEDWORDSFILTER(`t35`.`name$0`) OR NOT BANNEDWORDSFILTER(`t35`.`description$0`) OR NOT BANNEDWORDSFILTER(`t35`.`location$0`) AS `removed`
         FROM (SELECT `$cor6`.`_uuid$0`, `$cor6`.`_ingest_time$0`, `$cor6`.`_source_time$0`, `$cor6`.`userid$0`, `$cor6`.`id$0`, `$cor6`.`name$0`, `$cor6`.`email$0`, `$cor6`.`location$0`, `$cor6`.`time$0`, `$cor6`.`title$0`, `$cor6`.`description$0`, `$cor6`.`secret$0`, `$cor6`.`timestamp$0`
           FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
             FROM `eventupdate$i$11`) AS `$cor6`
            INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor6`.`timestamp$0` AS `t32` ON `$cor6`.`id$0$0` = `t32`.`id$1` AND `$cor6`.`secret$0$0` = `t32`.`secret$1`) AS `t35`
          LEFT JOIN (SELECT `$cor7`.`_uuid$0`, `$cor7`.`_ingest_time$0`, `$cor7`.`_source_time$0`, `$cor7`.`eventid$0`, `$cor7`.`auth_token$0`
           FROM `eventremoval$i$23` AS `$cor7`
            INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor7`.`_source_time$0` AS `t38` ON `t38`.`id$0` = 'removal' AND `t38`.`value$0` = `$cor7`.`auth_token$0`) AS `t39` ON `t35`.`id$0` = `t39`.`eventid$0` AND `t35`.`timestamp$0` < `t39`.`_source_time$0` AND `t39`.`_source_time$0` < (`t35`.`timestamp$0` + INTERVAL '31504464' SECOND(11))
         UNION ALL
         SELECT `t42`.`_uuid$0` AS `_uuid`, '' AS `removalId`, `t42`.`timestamp$0` AS `timestamp`, CAST(`t42`.`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `EXPR$3`, `t42`.`time$0` AS `time`, `t42`.`title$0` AS `title`, `t42`.`description$0` AS `description`, `t50`.`name`, `t42`.`location$0` AS `location`, FALSE AS `removed`
         FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
           FROM `conferenceevents$i$1`) AS `t42`
          INNER JOIN (SELECT `___uuid$0$pk$1`, CONCAT('speakerlength', SUM(`$f0`)) AS `name`, `window_time` AS `timestamp$0`
           FROM TABLE(TUMBLE(TABLE `query$3`, DESCRIPTOR(`timestamp$0`), INTERVAL '0.001' SECOND(1))) AS `t47`
           GROUP BY `___uuid$0$pk$1`, `window_start`, `window_end`, `window_time`) AS `t50` ON `t42`.`_uuid$0` = `t50`.`___uuid$0$pk$1` AND `t42`.`timestamp$0` = `t50`.`timestamp$0`) AS `t53`) AS `t55`) AS `t56`
  WHERE `$f11` = 1) AS `t57`
WHERE `time` > ? AND NOT `removed`

root$6 = SELECT `id` AS `id$0`, `_uuid` AS `_uuid$0`, `removalId` AS `removalid$0`, `timestamp` AS `timestamp$0`, `time` AS `time$0`, `title` AS `title$0`, `description` AS `description$0`, `name` AS `name$0`, `location` AS `location$0`, `removed` AS `removed$0`, `embedding$0`
FROM (SELECT *
  FROM (SELECT `id`, `_uuid`, `removalId`, `timestamp`, `time`, `title`, `description`, `name`, `location`, `removed`, `embedding$0`, ROW_NUMBER() OVER (PARTITION BY `id` ORDER BY `timestamp` DESC NULLS LAST) AS `$f11`
    FROM (SELECT `id$0` AS `id`, `_uuid$0` AS `_uuid`, `removalId`, `timestamp$0` AS `timestamp`, `time$0` AS `time`, `title$0` AS `title`, `description$0` AS `description`, `name$0` AS `name`, `location$0` AS `location`, `removed`, CHAR_LENGTH(`description$0`) AS `embedding$0`
      FROM (SELECT `t68`.`_uuid$0`, COALESCE(`t72`.`_uuid$0`, '') AS `removalId`, `t68`.`timestamp$0`, `t68`.`id$0`, `t68`.`time$0`, `t68`.`title$0`, `t68`.`description$0`, `t68`.`name$0`, `t68`.`location$0`, NOT BANNEDWORDSFILTER(`t68`.`name$0`) OR NOT BANNEDWORDSFILTER(`t68`.`description$0`) OR NOT BANNEDWORDSFILTER(`t68`.`location$0`) AS `removed`
         FROM (SELECT `$cor8`.`_uuid$0`, `$cor8`.`_ingest_time$0`, `$cor8`.`_source_time$0`, `$cor8`.`userid$0`, `$cor8`.`id$0`, `$cor8`.`name$0`, `$cor8`.`email$0`, `$cor8`.`location$0`, `$cor8`.`time$0`, `$cor8`.`title$0`, `$cor8`.`description$0`, `$cor8`.`secret$0`, `$cor8`.`timestamp$0`
           FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
             FROM `eventupdate$i$11`) AS `$cor8`
            INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor8`.`timestamp$0` AS `t65` ON `$cor8`.`id$0$0` = `t65`.`id$1` AND `$cor8`.`secret$0$0` = `t65`.`secret$1`) AS `t68`
          LEFT JOIN (SELECT `$cor9`.`_uuid$0`, `$cor9`.`_ingest_time$0`, `$cor9`.`_source_time$0`, `$cor9`.`eventid$0`, `$cor9`.`auth_token$0`
           FROM `eventremoval$i$23` AS `$cor9`
            INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor9`.`_source_time$0` AS `t71` ON `t71`.`id$0` = 'removal' AND `t71`.`value$0` = `$cor9`.`auth_token$0`) AS `t72` ON `t68`.`id$0` = `t72`.`eventid$0` AND `t68`.`timestamp$0` < `t72`.`_source_time$0` AND `t72`.`_source_time$0` < (`t68`.`timestamp$0` + INTERVAL '31504464' SECOND(11))
         UNION ALL
         SELECT `t75`.`_uuid$0` AS `_uuid`, '' AS `removalId`, `t75`.`timestamp$0` AS `timestamp`, CAST(`t75`.`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `EXPR$3`, `t75`.`time$0` AS `time`, `t75`.`title$0` AS `title`, `t75`.`description$0` AS `description`, `t83`.`name`, `t75`.`location$0` AS `location`, FALSE AS `removed`
         FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
           FROM `conferenceevents$i$1`) AS `t75`
          INNER JOIN (SELECT `___uuid$0$pk$1`, CONCAT('speakerlength', SUM(`$f0`)) AS `name`, `window_time` AS `timestamp$0`
           FROM TABLE(TUMBLE(TABLE `query$3`, DESCRIPTOR(`timestamp$0`), INTERVAL '0.001' SECOND(1))) AS `t80`
           GROUP BY `___uuid$0$pk$1`, `window_start`, `window_end`, `window_time`) AS `t83` ON `t75`.`_uuid$0` = `t83`.`___uuid$0$pk$1` AND `t75`.`timestamp$0` = `t83`.`timestamp$0`) AS `t86`) AS `t88`) AS `t89`
  WHERE `$f11` = 1) AS `t90`
WHERE `time` >= ? AND TEXTSEARCH(?, `title`, `description`) > 0 AND NOT `removed`

root$7 = SELECT `userid$0`, AVG(`embedding$0`) OVER (PARTITION BY `userid$0` ORDER BY `_source_time$0` ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `interestvector$0`, `_source_time$0`
FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `text$0`, `userid$0`, CHAR_LENGTH(`text$0`) AS `embedding$0`
  FROM `addinterest$i$20`) AS `t94`

root$8 = SELECT `userid$0`, `eventid$0`, `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `liked$0`
FROM `likes$i$14`

root$9 = SELECT `_uuid$0`, `removalId` AS `removalid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, `removed` AS `removed$0`
FROM (SELECT `t106`.`_uuid$0`, COALESCE(`t110`.`_uuid$0`, '') AS `removalId`, `t106`.`_ingest_time$0`, `t106`.`_source_time$0`, `t106`.`userid$0`, `t106`.`id$0`, `t106`.`name$0`, `t106`.`email$0`, `t106`.`location$0`, `t106`.`time$0`, `t106`.`title$0`, `t106`.`description$0`, `t106`.`secret$0`, `t106`.`timestamp$0`, NOT BANNEDWORDSFILTER(`t106`.`name$0`) OR NOT BANNEDWORDSFILTER(`t106`.`description$0`) OR NOT BANNEDWORDSFILTER(`t106`.`location$0`) AS `removed`
  FROM (SELECT `$cor10`.`_uuid$0`, `$cor10`.`_ingest_time$0`, `$cor10`.`_source_time$0`, `$cor10`.`userid$0`, `$cor10`.`id$0`, `$cor10`.`name$0`, `$cor10`.`email$0`, `$cor10`.`location$0`, `$cor10`.`time$0`, `$cor10`.`title$0`, `$cor10`.`description$0`, `$cor10`.`secret$0`, `$cor10`.`timestamp$0`
    FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
      FROM `eventupdate$i$11`) AS `$cor10`
     INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor10`.`timestamp$0` AS `t103` ON `$cor10`.`id$0$0` = `t103`.`id$1` AND `$cor10`.`secret$0$0` = `t103`.`secret$1`) AS `t106`
   LEFT JOIN (SELECT `$cor11`.`_uuid$0`, `$cor11`.`_ingest_time$0`, `$cor11`.`_source_time$0`, `$cor11`.`eventid$0`, `$cor11`.`auth_token$0`
    FROM `eventremoval$i$23` AS `$cor11`
     INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor11`.`_source_time$0` AS `t109` ON `t109`.`id$0` = 'removal' AND `t109`.`value$0` = `$cor11`.`auth_token$0`) AS `t110` ON `t106`.`id$0` = `t110`.`eventid$0` AND `t106`.`timestamp$0` < `t110`.`_source_time$0` AND `t110`.`_source_time$0` < (`t106`.`timestamp$0` + INTERVAL '31504464' SECOND(11))) AS `t111`
WHERE NOT `t111`.`removed`

query$10 = SELECT *
FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `last_updated$0`, `title$0`, `fromemail$0`, `toemail$0`, `textbody$0`, ROW_NUMBER() OVER (PARTITION BY `id$0` ORDER BY `last_updated$0` DESC NULLS LAST) AS `$f8`
  FROM (SELECT `id$0`, `_uuid$0`, `_ingest_time$0`, `last_updated$0`, `title$0`, `fromemail$0`, `toemail$0`, `textbody$0`
    FROM `emailtemplates$i$8`) AS `t115`) AS `t116`
WHERE `$f8` = 1

root$11 = SELECT `$cor12`.`_uuid$0`, `$cor12`.`email$0` AS `toemail$0`, `t117`.`fromemail$0`, `t117`.`title$0`, FORMAT(`t117`.`textbody$0`, `$cor12`.`name$0`, `$cor12`.`id$1`, `$cor12`.`secret$1`) AS `textbody$0`, `$cor12`.`timestamp$0`
FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, RANDOMID(12) AS `id$1`, RANDOMID(10) AS `secret$1`
  FROM (VALUES  (NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)) AS `t` (`_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`)
  WHERE 1 = 0) AS `$cor12`
 INNER JOIN `query$10` FOR SYSTEM_TIME AS OF `$cor12`.`timestamp$0` AS `t117` ON `t117`.`id$0` = 'confirmpost'

query$12 = SELECT *
FROM (SELECT `id`, `_uuid`, `removalId`, `timestamp`, `time`, `title`, `description`, `name`, `location`, `removed`, `embedding$0`, ROW_NUMBER() OVER (PARTITION BY `id` ORDER BY `timestamp` DESC NULLS LAST) AS `$f11`
  FROM (SELECT `id$0` AS `id`, `_uuid$0` AS `_uuid`, `removalId`, `timestamp$0` AS `timestamp`, `time$0` AS `time`, `title$0` AS `title`, `description$0` AS `description`, `name$0` AS `name`, `location$0` AS `location`, `removed`, CHAR_LENGTH(`description$0`) AS `embedding$0`
    FROM (SELECT `t132`.`_uuid$0`, COALESCE(`t136`.`_uuid$0`, '') AS `removalId`, `t132`.`timestamp$0`, `t132`.`id$0`, `t132`.`time$0`, `t132`.`title$0`, `t132`.`description$0`, `t132`.`name$0`, `t132`.`location$0`, NOT BANNEDWORDSFILTER(`t132`.`name$0`) OR NOT BANNEDWORDSFILTER(`t132`.`description$0`) OR NOT BANNEDWORDSFILTER(`t132`.`location$0`) AS `removed`
       FROM (SELECT `$cor15`.`_uuid$0`, `$cor15`.`_ingest_time$0`, `$cor15`.`_source_time$0`, `$cor15`.`userid$0`, `$cor15`.`id$0`, `$cor15`.`name$0`, `$cor15`.`email$0`, `$cor15`.`location$0`, `$cor15`.`time$0`, `$cor15`.`title$0`, `$cor15`.`description$0`, `$cor15`.`secret$0`, `$cor15`.`timestamp$0`
         FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `userid$0`, `id$0`, `name$0`, `email$0`, `location$0`, `time$0`, `title$0`, `description$0`, `secret$0`, `timestamp$0`, CAST(`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `id$0$0`, CAST(`secret$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `secret$0$0`
           FROM `eventupdate$i$11`) AS `$cor15`
          INNER JOIN `query$1` FOR SYSTEM_TIME AS OF `$cor15`.`timestamp$0` AS `t129` ON `$cor15`.`id$0$0` = `t129`.`id$1` AND `$cor15`.`secret$0$0` = `t129`.`secret$1`) AS `t132`
        LEFT JOIN (SELECT `$cor16`.`_uuid$0`, `$cor16`.`_ingest_time$0`, `$cor16`.`_source_time$0`, `$cor16`.`eventid$0`, `$cor16`.`auth_token$0`
         FROM `eventremoval$i$23` AS `$cor16`
          INNER JOIN `query$2` FOR SYSTEM_TIME AS OF `$cor16`.`_source_time$0` AS `t135` ON `t135`.`id$0` = 'removal' AND `t135`.`value$0` = `$cor16`.`auth_token$0`) AS `t136` ON `t132`.`id$0` = `t136`.`eventid$0` AND `t132`.`timestamp$0` < `t136`.`_source_time$0` AND `t136`.`_source_time$0` < (`t132`.`timestamp$0` + INTERVAL '31504464' SECOND(11))
       UNION ALL
       SELECT `t139`.`_uuid$0` AS `_uuid`, '' AS `removalId`, `t139`.`timestamp$0` AS `timestamp`, CAST(`t139`.`id$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `EXPR$3`, `t139`.`time$0` AS `time`, `t139`.`title$0` AS `title`, `t139`.`description$0` AS `description`, `t147`.`name`, `t139`.`location$0` AS `location`, FALSE AS `removed`
       FROM (SELECT `_uuid$0`, `_ingest_time$0`, `id$0`, `last_updated$0`, `time$0`, `title$0`, `location$0`, `speakers$0`, `description$0`, `timestamp$0`
         FROM `conferenceevents$i$1`) AS `t139`
        INNER JOIN (SELECT `___uuid$0$pk$1`, CONCAT('speakerlength', SUM(`$f0`)) AS `name`, `window_time` AS `timestamp$0`
         FROM TABLE(TUMBLE(TABLE `query$3`, DESCRIPTOR(`timestamp$0`), INTERVAL '0.001' SECOND(1))) AS `t144`
         GROUP BY `___uuid$0$pk$1`, `window_start`, `window_end`, `window_time`) AS `t147` ON `t139`.`_uuid$0` = `t147`.`___uuid$0$pk$1` AND `t139`.`timestamp$0` = `t147`.`timestamp$0`) AS `t150`) AS `t152`) AS `t153`
WHERE `$f11` = 1

root$13 = SELECT `$cor13`.`_uuid$0`, `t124`.`toemail$0`, `t124`.`fromemail$0`, `t124`.`title$0`, FORMAT(`t124`.`textbody$0`, `$cor13`.`eventid$0`, `$cor13`.`title`, `$cor13`.`description`, `$cor13`.`name`) AS `textbody$0`, `$cor13`.`_source_time$0`
FROM (SELECT *
  FROM (SELECT `_uuid$0`, `_ingest_time$0`, `_source_time$0`, `eventid$0`, `userid$0`, CAST(`eventid$0` AS VARCHAR(65536) CHARACTER SET `UTF-16LE`) AS `eventid$0$0`
    FROM `reportevent$i$17`) AS `$cor14`
   INNER JOIN `query$12` FOR SYSTEM_TIME AS OF `$cor14`.`_source_time$0` AS `t154` ON `$cor14`.`eventid$0$0` = `t154`.`id`) AS `$cor13`
 INNER JOIN `query$10` FOR SYSTEM_TIME AS OF `$cor13`.`_source_time$0` AS `t124` ON `t124`.`id$0` = 'eventflag'

