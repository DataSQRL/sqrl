IMPORT datasqrl-central.Submission AS _SubmissionRaw;

Submission := SELECT *,  COALESCE(variant, 'default') AS variant0,
                     concat('https://repository.datasqrl.com/',file) AS repoURL
              FROM _SubmissionRaw;

Package := SELECT DISTINCT name FROM Submission;

Package.latest := SELECT * FROM Submission s WHERE this.name = s.name AND s.latest = TRUE ORDER BY s.submissionTime DESC;
Package.versions := SELECT * FROM  Submission s WHERE this.name = s.name ORDER BY s.submissionTime DESC;

TopicPackages := SELECT s.name AS pkgName, k.name AS topicName, COUNT(1) AS numSubmissions, MAX(submissionTime) AS lastSubmission
                 FROM Submission s JOIN s.keywords k
                 GROUP BY pkgName, topicName ORDER BY numSubmissions DESC;

TopicPackages.latest := SELECT * FROM  Submission s WHERE this.pkgName = s.name AND s.latest = TRUE ORDER BY s.submissionTime DESC;

TopicSearch := SELECT k.name AS topicName, COUNT(DISTINCT s.name) AS numPackages
               FROM Submission s JOIN s.keywords k
               GROUP BY topicName ORDER BY numPackages DESC;
