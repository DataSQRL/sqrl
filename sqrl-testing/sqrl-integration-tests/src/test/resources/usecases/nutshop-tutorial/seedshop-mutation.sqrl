IMPORT seedshop.Orders;
IMPORT seedshop.Products;
IMPORT seedshop.Customers;
IMPORT seedshop-mutation.ProductVisit;
IMPORT time.*;

Orders.totals := SELECT sum(quantity * unit_price - coalesce(discount, 0.0)) as price,
                  sum(coalesce(discount, 0.0)) as saving FROM @.items;

Customers := DISTINCT Customers ON id ORDER BY timestamp DESC;
Customers.purchases := JOIN Orders ON Orders.customerid = @.id;
Customers.country0 := coalesce(country, 'none');
Orders.customer := JOIN Customers ON @.customerid = Customers.id;

Customers.spending := SELECT endOfWeek(p.time) AS week,
         sum(t.price) AS spend, sum(t.saving) AS saved
      FROM @.purchases p JOIN p.totals t
      GROUP BY week ORDER BY week DESC;

Customers.order_stats := SELECT sum(t.price) as total_spend, sum(t.saving) as total_saved,
                               count(1) as num_orders
                        FROM @.purchases p JOIN p.totals t;


Customers.past_purchases := SELECT i.productid, count(1) as num_orders,
         sum(i.quantity) as total_quantity
      FROM @ JOIN Orders o ON o.customerid = @.id JOIN o.items i
      GROUP BY i.productid
      ORDER BY num_orders DESC, total_quantity DESC;

NumOrders := SELECT COUNT(*) AS count FROM Orders;

Products := DISTINCT Products ON id ORDER BY updated DESC;

_OrderItems := SELECT o.id, o.time, o.customerid, i.* FROM Orders o JOIN o.items i;

-- aggregating by country
Products.monthly_by_country := SELECT c.country0 AS country, endOfMonth(o.time) as month, sum(o.quantity) as quantity,
         sum(o.quantity * o.unit_price) as spend, sum(o.quantity * @.weight_in_gram) as weight
      FROM @ JOIN _OrderItems o ON o.productid = @.id JOIN Customers c ON o.customerid =c.id
      GROUP BY country, month;

Customers.product_visits := SELECT productid, count(1) as visits
                            FROM @ JOIN ProductVisit v ON @.id = v.customerid
                            WHERE v.event_time > now() - INTERVAL 30 DAY
                            GROUP BY productid ORDER BY visits DESC;

Customers.category_visits := SELECT p.category, count(1) as visits
                            FROM @ JOIN ProductVisit v ON @.id = v.customerid
                                   JOIN Products p ON v.productid = p.id
                            WHERE v.event_time > now() - INTERVAL 1 DAY
                            GROUP BY category ORDER BY visits DESC;
