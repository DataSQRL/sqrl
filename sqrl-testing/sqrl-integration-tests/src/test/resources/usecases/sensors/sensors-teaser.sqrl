IMPORT sensor-local.SensorReading; -- Import sensor data

/* Aggregate sensor readings to second */
SecReading := SELECT sensorid, window_time as timeSec,
        avg(temperature) as temp FROM SensorReading
    FROM TABLE(TUMBLE(TABLE SensorReading, DESCRIPTOR(`timestamp`), INTERVAL '1' SECONDS))
    GROUP BY sensorid, window_start, window_end, window_time
    ORDER BY timeSec DESC;

/* Get max temperature in last minute */
_SensorMaxTempWindow := SELECT sensorid, window_time, max(temp) as maxTemp
    FROM TABLE(HOP(TABLE SecReading, DESCRIPTOR(timeSec), INTERVAL '5' SECONDS, INTERVAL '1' MINUTES))
    GROUP BY sensorid, window_start, window_end, window_time;

SensorMaxTemp := DISTINCT _SensorMaxTempWindow ON sensorid ORDER BY window_time DESC;


/* =======TEST CASES======== */

/*+test */
SecReadingTest := SELECT * FROM SecReading ORDER BY timeSec DESC, temp DESC LIMIT 5;

/*+test */
SensorMaxTempTest := SELECT * FROM SensorMaxTemp ORDER BY maxTemp DESC LIMIT 5;
