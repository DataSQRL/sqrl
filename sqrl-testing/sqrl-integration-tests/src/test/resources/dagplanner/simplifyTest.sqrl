IMPORT ecommerceTs.Customer;
IMPORT ecommerceTs.Orders AS ExternalOrders;
IMPORT ecommerceTs.* AS _;

CustomerByTime2 := DISTINCT Customer ON customerid ORDER BY `timestamp` DESC NULLS LAST;

AnotherCustomer := SELECT customerid, email FROM _customer WHERE customerid > 100;

/*+filtered_distinct_order*/
CustomerByMultipleTime := DISTINCT Customer ON customerid, email ORDER BY `timestamp` DESC, lastUpdated ASC;

ExplicitDistinct := SELECT customerid, `timestamp`, name FROM (SELECT *, (ROW_NUMBER() OVER (PARTITION BY customerid ORDER BY `timestamp` DESC)) AS _rownum FROM Customer) WHERE (_rownum = 1);

Customer.related := JOIN Customer other ON this.customerid = other.customerid ORDER BY other.`timestamp`;

Customer.related($length : INT) := JOIN Customer other ON this.customerid = other.customerid
                AND CHAR_LENGTH(other.email) >= $length ORDER BY other.`timestamp`;


/** This is for selected customers
    and their orders
  */ /* ignored comment */
/*+ primary_key(id, name), index(name) */
SelectCustomers := SELECT * From Customer WHERE customerid > 0 ORDER BY `timestamp` DESC LIMIT 10;

CustomerSubscription := SUBSCRIBE SELECT * FROM Customer;

CustomerSubscriptionById($minId : INT) := SUBSCRIBE SELECT * FROM Customer WHERE customerid > $minId;

UnnestOrders := SELECT o.id, o.customerid, o.`time`, e.productid, e.quantity, e.discount FROM ExternalOrders o CROSS JOIN UNNEST(entries) e;
UnnestOrders.newId := id + productid;

CREATE TABLE Orders (
    orderid INT,
    amount FLOAT,
    PRIMARY KEY (orderid) NOT ENFORCED
);

CustomerTimeWindow := SELECT
                          window_start, window_end,
                          COUNT(DISTINCT email) AS unique_email_count
                      FROM TABLE(
                              TUMBLE(TABLE Customer, DESCRIPTOR(`timestamp`), INTERVAL '1' MINUTE)
                           )
                      GROUP BY
                          window_start, window_end;

/*+ test, query */
CustomerTimeWindowTest := SELECT * FROM CustomerTimeWindow ORDER BY window_end DESC;

CustomerQuery($id: BIGINT) := SELECT * FROM Customer WHERE customerid = $id;