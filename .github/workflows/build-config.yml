name: Build and test SQRL with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Setup Timezone
      uses: szenius/set-timezone@v1.1
      with:
        timezoneLinux: "America/Los_Angeles"
    - name: checkout
      uses: actions/checkout@v3

    - name: Configure AWS credentials from Test account
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-region: us-east-1
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    - name: Start RDS
      run: |
        aws rds create-db-instance \
        --db-instance-identifier test-mysql-instance \
        --db-instance-class db.t4g.micro \
        --engine postgres \
        --master-username testuser \
        --master-user-password testpass1234 \
        --allocated-storage 20 \
        --publicly-accessible
    - name: Compile and run
      run: |
        sqrl compile 

    - name: Deploy
      run: |
        aws lambda create-function --function-name CliTestFun 
        --runtime java8 --region ap-south-1 
        --role arn:aws:iam::XXXXXXXXXXXX:role/aws-lambda-execution-role 
        --handler com.example.demo.Search::handleRequest 
        
        

    - name: Wait for RDS
      run: |
        aws rds wait db-instance-available --db-instance-identifier test-mysql-instance

    - name: Build and deploy
#    - name: Set up JDK 11
#      uses: actions/setup-java@v3
#      with:
#        java-version: '11'
#        distribution: 'adopt'
#        cache: maven
#    - name: Build SQRL
#      run: mvn -B -U -e clean install --no-transfer-progress
#    - name: Set up Go
#      uses: actions/setup-go@v3
#      with:
#        go-version: 1.15
#    - name: Build SQRL cli
#      run: |
#        cd sqrl-cli
#        go build -v ./...
