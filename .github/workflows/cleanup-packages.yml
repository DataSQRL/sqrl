name: Cleanup Package Versions

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  discover-and-cleanup-maven-packages:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Discover and cleanup Maven packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Discovering Maven packages..."
          
          # Get all Maven packages for the organization
          packages=$(gh api "/orgs/DataSQRL/packages?package_type=maven" --jq '.[].name' 2>/dev/null || echo "")
          
          if [ -z "$packages" ]; then
            echo "No Maven packages found or insufficient permissions"
            exit 0
          fi
          
          echo "Found Maven packages:"
          echo "$packages"
          
          # Clean up each package
          echo "$packages" | while read -r package_name; do
            if [ -n "$package_name" ]; then
              echo "Cleaning up Maven package: $package_name"
              gh api \
                --method GET \
                -H "Accept: application/vnd.github+json" \
                "/orgs/DataSQRL/packages/maven/$package_name/versions" \
                --jq '.[] | select(.metadata.package_type == "maven" and (.name | test("SNAPSHOT|alpha|beta|rc|dev"; "i"))) | .id' | \
                head -n -10 | \
                while read -r version_id; do
                  if [ -n "$version_id" ]; then
                    echo "Deleting version ID: $version_id"
                    gh api \
                      --method DELETE \
                      -H "Accept: application/vnd.github+json" \
                      "/orgs/DataSQRL/packages/maven/$package_name/versions/$version_id" || echo "Failed to delete version $version_id"
                  fi
                done
            fi
          done

  discover-and-cleanup-container-packages:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Discover and cleanup Container packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Discovering Container packages..."
          
          # Get all Container packages for the organization
          packages=$(gh api "/orgs/DataSQRL/packages?package_type=container" --jq '.[].name' 2>/dev/null || echo "")
          
          if [ -z "$packages" ]; then
            echo "No Container packages found or insufficient permissions"
            exit 0
          fi
          
          echo "Found Container packages:"
          echo "$packages"
          
          # Clean up each package
          echo "$packages" | while read -r package_name; do
            if [ -n "$package_name" ]; then
              echo "Cleaning up Container package: $package_name"
              gh api \
                --method GET \
                -H "Accept: application/vnd.github+json" \
                "/orgs/DataSQRL/packages/container/$package_name/versions" \
                --jq '.[] | select(.metadata.container.tags | length == 0) | .id' | \
                head -n -10 | \
                while read -r version_id; do
                  if [ -n "$version_id" ]; then
                    echo "Deleting untagged version ID: $version_id"
                    gh api \
                      --method DELETE \
                      -H "Accept: application/vnd.github+json" \
                      "/orgs/DataSQRL/packages/container/$package_name/versions/$version_id" || echo "Failed to delete version $version_id"
                  fi
                done
            fi
          done
